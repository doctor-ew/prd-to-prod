# Milestone MS-03.01-A: Provision and Configure Production Database

## Framework: S-P-A-R-K

### Situation
Our application is fully functional in the development environment using a local SQLite database. However, SQLite is not suitable for production. To prepare for deployment, we need to provision a robust, scalable database and configure our application to connect to it in the production environment.

### Purpose
The goal is to create a Vercel Postgres database and connect it to our Vercel project. This involves setting up production-specific environment variables and ensuring our Prisma schema is compatible with PostgreSQL.

### Audience
This prompt is for an AI coding assistant or developer performing a one-time infrastructure setup task. The steps involve interacting with the Vercel dashboard.

### Roadmap
1.  Create a new Postgres database in the Vercel dashboard.
2.  Link the new database to our Vercel project.
3.  Update the Prisma schema to officially use the `postgresql` provider.
4.  Configure the production environment variables in Vercel's project settings.
5.  Generate a new Prisma client tailored for PostgreSQL.

### Knowledge
-   Vercel provides managed serverless databases (Vercel Postgres).
-   Prisma can switch between database providers (`sqlite`, `postgresql`) with minor configuration changes.
-   Vercel automatically injects database connection strings as environment variables into the project's production environment.

---

## Learning Outcomes

-   **Outcome 1**: Learn how to provision and manage serverless databases on Vercel.
-   **Outcome 2**: Understand how to configure a production environment for a Next.js application, particularly managing database connection strings.
-   **Outcome 3**: Reinforce the process of configuring Prisma for different database providers (development vs. production).

---

## Context from Source Docs

**Business Rationale (PRD)**: To ensure the application is available and scalable for a large number of users during FIFA events, a production-grade database is non-negotiable.
**WBS Alignment**: Phase 5: Deployment and Launch. This is a key part of Task 5.1 (Production infrastructure setup).
**Dependencies**: All previous milestones.
**Files to Create/Modify**:
-   `prisma/schema.prisma`

**Acceptance Criteria**:
-   A Vercel Postgres database is created and linked to the project.
-   The `POSTGRES_PRISMA_URL` and `POSTGRES_URL_NON_POOLING` environment variables are present in the Vercel project's production settings.
-   The `prisma/schema.prisma` file is updated to use the `postgresql` provider.
-   Running `pnpm prisma generate` completes successfully after the schema change.

---

## Guardrails

-   **Environment-Specific Constraints**: The production environment **must** use Vercel Postgres. SQLite is for development only.
-   **Security**: Database connection strings are highly sensitive secrets. They **must** be managed through the Vercel dashboard and never hardcoded or committed to git.
-   **Data Handling**: The Prisma schema must be compatible with PostgreSQL (which it already is, as we've used standard types).

---

## Implementation Checklist

-   [ ] **Task 1**: Provision the Vercel Postgres Database.
    -   **Action**:
        1.  Go to your Vercel Dashboard.
        2.  Navigate to the "Storage" tab.
        3.  Click "Create Database" and select "Postgres".
        4.  Follow the prompts to create the database, giving it a name and selecting a region.
        5.  In the final step, connect the new database to your Atlanta FIFA Navigator project.
    -   **Acceptance**: The database is created, and the connection environment variables are automatically added to your Vercel project.
-   [ ] **Task 2**: Update the Prisma Schema for PostgreSQL.
    -   **Action**: Open `prisma/schema.prisma` and change the `datasource db` block. The `provider` should now be `postgresql`.
    ```prisma
    // ... generator client ...

    datasource db {
      provider  = "postgresql"
      url       = env("POSTGRES_PRISMA_URL")
      directUrl = env("POSTGRES_URL_NON_POOLING")
    }

    // ... all your models ...
    ```
    -   **Note**: This schema will now be used for production. For local development, Prisma is smart enough to still use the `DATABASE_URL="file:./dev.db"` from your `.env` file if you run `prisma migrate dev`, but production builds on Vercel will use the new Postgres provider.
    -   **Acceptance**: The `schema.prisma` file is updated.
-   [ ] **Task 3**: Re-generate the Prisma Client.
    -   **Action**: Run this command in your local/Codespaces terminal: `pnpm prisma generate`
    -   **Acceptance**: The command completes successfully. This updates the Prisma Client to be optimized for PostgreSQL.

---

## Testing Requirements

-   [ ] **Manual Verification**:
    1.  Go to your Vercel project's dashboard.
    2.  Navigate to "Settings" -> "Environment Variables".
    3.  **Confirm**: You see several variables prefixed with `POSTGRES_`, including `POSTGRES_PRISMA_URL`. They should be managed by "Vercel Integrations".
    4.  Run `pnpm prisma migrate dev` locally one more time. **Confirm** it still works with your SQLite database, proving that your local environment is unaffected.

---

## Success Criteria

This milestone is complete when:
1.  A production-ready Vercel Postgres database has been provisioned and connected.
2.  The Prisma schema has been updated to target PostgreSQL for production builds.
3.  The necessary environment variables are securely stored in Vercel.
4.  The local development environment using SQLite remains functional.

# Milestone MS-02.01-A: Internationalization (i18n) Setup

## Framework: S-T-A-G-E

### Scope
Implement the foundational framework for internationalization (i18n) in the Next.js application. This involves setting up middleware to detect and handle language prefixes in the URL (e.g., `/en` and `/es`), creating dictionary files for storing translations, and creating a utility function to load the correct dictionary based on the current language. This milestone does not include creating the UI for the user to switch languages; it only sets up the underlying mechanism.

### Timeline
This is a foundational task that should be completed before any user-facing text is finalized. It enables all future UI work to be developed with localization in mind from the start.

### Audience
The end-users are both English and Spanish speakers, as defined in the PRD. This technical setup directly enables the feature for them.

### Guardrails
-   **Technology**: You **must** use the Next.js Middleware for route handling. You **must not** use a third-party i18n routing library like `next-i18next` to keep the implementation simple and based on modern Next.js features.
-   **Data Handling**: Translation strings **must** be stored in simple JSON files (`en.json`, `es.json`).
-   **Scope**: This task is only for setting up the routing and data-loading mechanism. Do not implement the language switcher UI component yet.

### Environment
The i18n logic must function correctly in both the GitHub Codespaces development environment and the Vercel production environment.

---

## Learning Outcomes

-   **Outcome 1**: Learn how to implement internationalization routing using Next.js Middleware.
-   **Outcome 2**: Understand a common pattern for managing translation strings (dictionaries) and loading them dynamically.
-   **Outcome 3**: Establish a scalable foundation for adding more languages and translations throughout the application.

---

## Context from Source Docs

**Business Rationale (PRD)**: To "Offer bilingual support (English and Spanish) to accommodate a diverse user base." This is a core requirement.
**WBS Alignment**: Phase 3 -> Task 3.4 (Multilingual support).
**Dependencies**: MS-01.01 (Project Setup).
**Files to Create/Modify**:
-   `src/middleware.ts` (new file)
-   `src/i18n/en.json` (new file)
-   `src/i18n/es.json` (new file)
-   `src/i18n/get-dictionary.ts` (new file)
-   `src/app/(main)/layout.tsx` (to add `lang` attribute)

**Acceptance Criteria**:
-   The application supports `/en` and `/es` URL prefixes.
-   Visiting the root URL (`/`) automatically redirects to the default locale (`/en`).
-   Visiting `/en/some-page` or `/es/some-page` renders the content for that page correctly.
-   The `getDictionary` function successfully returns the content of the correct JSON file based on the locale.

---

## Implementation Checklist

-   [ ] **Task 1**: Create the dictionary files for translations.
    -   **Action**: Create a new directory `src/i18n`. Inside it, create two files:
        -   `src/i18n/en.json`:
            ```json
            {
              "upcoming_events": "Upcoming Events"
            }
            ```
        -   `src/i18n/es.json`:
            ```json
            {
              "upcoming_events": "Próximos Eventos"
            }
            ```
    -   **Acceptance**: The two JSON files are created with the sample translation.
-   [ ] **Task 2**: Create the dictionary loader utility.
    -   **Action**: Create a new file at `src/i18n/get-dictionary.ts`. Add the following code.
    ```ts
    import 'server-only';
    import type { Locale } from './i18n-config';

    const dictionaries = {
      en: () => import('./en.json').then((module) => module.default),
      es: () => import('./es.json').then((module) => module.default),
    };

    export const getDictionary = async (locale: Locale) => dictionaries[locale]();
    ```
    -   **Acceptance**: The `get-dictionary.ts` file is created.
-   [ ] **Task 3**: Create the i18n configuration file.
    -   **Action**: Create a new file at `src/i18n/i18n-config.ts`. Add the following code.
    ```ts
    export const i18n = {
      defaultLocale: 'en',
      locales: ['en', 'es'],
    } as const;

    export type Locale = (typeof i18n)['locales'][number];
    ```
    -   **Acceptance**: The `i18n-config.ts` file is created.
-   [ ] **Task 4**: Implement the routing middleware.
    -   **Action**: Create a new file at `src/middleware.ts`. Add the following code to handle locale detection and redirection.
    ```ts
    import { NextResponse } from 'next/server';
    import type { NextRequest } from 'next/server';
    import { i18n } from './i18n/i18n-config';

    export function middleware(request: NextRequest) {
      const { pathname } = request.nextUrl;
      const pathnameIsMissingLocale = i18n.locales.every(
        (locale) => !pathname.startsWith(`/${locale}/`) && pathname !== `/${locale}`
      );

      // Redirect if there is no locale
      if (pathnameIsMissingLocale) {
        const locale = i18n.defaultLocale;
        return NextResponse.redirect(
          new URL(`/${locale}${pathname}`, request.url)
        );
      }
    }

    export const config = {
      // Matcher ignoring `/_next/` and `/api/`
      matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
    };
    ```
    -   **Acceptance**: The `middleware.ts` file is created and configured.
-   [ ] **Task 5**: Update the root layout and page to use the dictionary.
    -   **Action**: Modify `src/app/(main)/layout.tsx` and `src/app/(main)/page.tsx` to handle the new URL structure and use the translations.
        -   `src/app/(main)/layout.tsx`:
            ```tsx
            export default function RootLayout({
              children,
              params,
            }: {
              children: React.ReactNode;
              params: { lang: string };
            }) {
              return (
                <html lang={params.lang}>
                  <body>{children}</body>
                </html>
              );
            }
            ```
        -   Rename `src/app/(main)/page.tsx` to `src/app/[lang]/(main)/page.tsx`.
        -   Update the new `page.tsx` to fetch and use the dictionary.
            ```tsx
            import { PrismaClient } from '@prisma/client';
            import MapView from '@/components/MapView';
            import EventList from '@/components/EventList';
            import { getDictionary } from '@/i18n/get-dictionary';
            import { Locale } from '@/i18n/i18n-config';

            // ... (keep prisma and getEvents function)

            export default async function Home({ params: { lang } }: { params: { lang: Locale } }) {
              const dictionary = await getDictionary(lang);
              const events = await getEvents();

              return (
                <main className="h-screen w-screen relative">
                  <MapView />
                  <EventList events={events} dictionary={dictionary} />
                </main>
              );
            }
            ```
        -   Update `src/components/EventList.tsx` to accept and use the `dictionary`.
            ```tsx
            // ... imports
            type EventListProps = {
              events: Event[];
              dictionary: { upcoming_events: string };
            };

            const EventList = ({ events, dictionary }: EventListProps) => {
              return (
                <div className="absolute top-4 left-4 w-full max-w-sm h-[calc(100vh-2rem)] overflow-y-auto space-y-4 p-1">
                  <h2 className="text-2xl font-bold text-gray-900 px-3">{dictionary.upcoming_events}</h2>
                  {/* ... rest of component */}
                </div>
              );
            };
            export default EventList;
            ```
    -   **Acceptance**: The file structure and code are updated.

---

## Testing Requirements

-   [ ] **Manual Verification**:
    1.  Run `pnpm dev`.
    2.  Open `http://localhost:3000` in your browser.
    3.  **Confirm**: You are automatically redirected to `http://localhost:3000/en`.
    4.  **Confirm**: The "Upcoming Events" title is visible in English.
    5.  Navigate to `http://localhost:3000/es`.
    6.  **Confirm**: The title changes to "Próximos Eventos".
    7.  **Confirm**: The rest of the page (map, event cards) still renders correctly in both versions.

---

## Success Criteria

This milestone is complete when:
1.  The application correctly handles `/en` and `/es` language prefixes in the URL.
2.  The middleware correctly redirects from the root path to the default language.
3.  The `EventList` title is successfully translated based on the URL.
4.  All acceptance criteria are met.

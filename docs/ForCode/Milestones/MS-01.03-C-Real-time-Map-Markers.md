# Milestone MS-01.03-C: Real-time Map Markers and Updates

## Framework: S-P-A-R-K

### Situation
Our application now has a `/api/transit` endpoint that provides real-time location data for both MARTA buses and trains. However, this data is not yet visible to the user. We need to consume this API from the frontend and display the vehicles as moving markers on the map.

### Purpose
The goal is to bring the map to life by creating a real-time overlay of transit vehicles. This is a core feature that directly fulfills the user's need for live transportation information. This will be achieved by fetching data at a regular interval and dynamically rendering a marker for each vehicle.

### Audience
This prompt is for an AI coding assistant being guided by a non-technical user. The instructions must be followed exactly.

### Roadmap
1.  Install `swr`, the recommended client-side data fetching library.
2.  Create a new `TransitMarker` component that can visually distinguish between a bus and a train.
3.  Modify the `MapView` component to use the `useSWR` hook to fetch data from the `/api/transit` endpoint automatically and periodically.
4.  Render a `TransitMarker` for each vehicle returned by the API.

### Knowledge
-   You will use the `useSWR` hook for client-side data fetching, which handles caching, revalidation, and polling.
-   You will map over the arrays of bus and train data to render a list of components, a standard pattern in React.
-   Markers will be customized based on the `type` property of the vehicle data.

---

## Learning Outcomes

-   **Outcome 1**: Learn how to implement efficient, real-time client-side data fetching and polling using the `swr` library.
-   **Outcome 2**: Understand how to dynamically render lists of components from an API response.
-   **Outcome 3**: Gain experience in creating components that can be styled conditionally based on the data they receive (e.g., showing a different icon for a bus vs. a train).

---

## Context from Source Docs

**Business Rationale (PRD)**: To provide real-time navigation, users must be able to see where transit vehicles currently are. This feature makes the map a dynamic, tactical tool rather than a static image.
**WBS Alignment**: Phase 3 -> Task 3.6. This milestone completes the "MARTA Transit API integration" feature.
**Dependencies**: MS-01.03-B (Train API and Proxy).
**Files to Create/Modify**:
-   `package.json`
-   `src/components/TransitMarker.tsx` (new file)
-   `src/components/MapView.tsx`

**Acceptance Criteria**:
-   Bus and train markers appear on the map.
-   The positions of the markers on the map update automatically every 20 seconds without a full page reload.
-   Bus markers are visually distinct from train markers (e.g., different color or icon).
-   The application correctly fetches data from the `/api/transit` endpoint.

---

## Guardrails

-   **Data Fetching**: You **must** use `swr` for fetching the transit data on the client. Do not use a simple `useEffect` with `fetch`.
-   **Performance**: The polling interval should be set to 20 seconds (`refreshInterval: 20000`) to balance real-time accuracy with API usage. The markers should render efficiently without causing the map to lag.
-   **UX**: The markers must be clear and easy to distinguish. A loading state should be handled gracefully (though `swr` does much of this automatically).
-   **Code Quality**: The marker UI **must** be encapsulated in its own `TransitMarker.tsx` component.

---

## Implementation Checklist

-   [ ] **Task 1**: Install the `swr` library.
    -   **Action**: Run this exact command in the terminal: `pnpm add swr`
    -   **Acceptance**: The dependency is added to `package.json`.
-   [ ] **Task 2**: Create the `TransitMarker` component.
    -   **Action**: Create a new file at `src/components/TransitMarker.tsx`. Add the following code. This component will render a different colored circle for buses and trains.
    ```tsx
    'use client';

    import React from 'react';
    import { AdvancedMarker } from '@vis.gl/react-google-maps';
    import { TransitVehicle } from '@/types';

    const TransitMarker = ({ vehicle }: { vehicle: TransitVehicle }) => {
      const isBus = vehicle.type === 'bus';
      const color = isBus ? '#4285F4' : '#FBBC05'; // Blue for bus, Yellow for train

      return (
        <AdvancedMarker position={{ lat: vehicle.lat, lng: vehicle.lon }}>
          <div
            style={{
              width: 16,
              height: 16,
              backgroundColor: color,
              borderRadius: '50%',
              border: '2px solid white',
              boxShadow: '0 0 5px rgba(0,0,0,0.5)',
            }}
            title={`Route: ${vehicle.route}`}
          />
        </AdvancedMarker>
      );
    };

    export default TransitMarker;
    ```
    -   **Acceptance**: The file `src/components/TransitMarker.tsx` is created with the specified content.
-   [ ] **Task 3**: Update `MapView` to fetch and display the transit markers.
    -   **Action**: Open `src/components/MapView.tsx` and replace its content with the following. This version introduces the `useSWR` hook for polling the API.
    ```tsx
    'use client';

    import React, { useState, useEffect } from 'react';
    import { APIProvider, Map, useMap } from '@vis.gl/react-google-maps';
    import useSWR from 'swr';
    import { TransitVehicle } from '@/types';
    import VenueMarker from './VenueMarker';
    import MapControl from './MapControl';
    import TransitMarker from './TransitMarker';

    const fetcher = (url: string) => fetch(url).then((res) => res.json());

    // ... (Keep the TrafficLayer component from the previous milestone)
    const TrafficLayer = ({ showTraffic }: { showTraffic: boolean }) => {
        const map = useMap();
        useEffect(() => {
            if (!map) return;
            const trafficLayer = new google.maps.TrafficLayer();
            if (showTraffic) {
            trafficLayer.setMap(map);
            }
            return () => {
            trafficLayer.setMap(null);
            };
        }, [map, showTraffic]);
        return null;
    };


    const MapView = () => {
      const [showTraffic, setShowTraffic] = useState(false);
      const { data, error } = useSWR('/api/transit', fetcher, { refreshInterval: 20000 });

      const position = { lat: 33.7490, lng: -84.3880 };
      const stadiumPosition = { lat: 33.7555, lng: -84.4008 };

      if (error) console.error("SWR Error:", error);

      const allVehicles: TransitVehicle[] = data ? [...data.buses, ...data.trains] : [];

      return (
        <APIProvider apiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!}>
          <div className="h-full w-full relative">
            <Map
              defaultCenter={position}
              defaultZoom={14}
              gestureHandling={'greedy'}
              disableDefaultUI={true}
              mapId="fifa-map-style"
            >
              <VenueMarker lat={stadiumPosition.lat} lng={stadiumPosition.lng} />
              <TrafficLayer showTraffic={showTraffic} />
              {allVehicles.map((vehicle) => (
                <TransitMarker key={vehicle.id} vehicle={vehicle} />
              ))}
            </Map>
            <MapControl onClick={() => setShowTraffic(!showTraffic)} isActive={showTraffic}>
              ðŸš¦
            </MapControl>
          </div>
        </APIProvider>
      );
    };

    export default MapView;
    ```
    -   **Acceptance**: `MapView.tsx` is updated to use `useSWR`, fetch data from `/api/transit`, and render the `TransitMarker` components.

---

## Testing Requirements

-   [ ] **Manual Verification**:
    1.  Run `pnpm dev`.
    2.  Open the application in a browser.
    3.  **Confirm**: After a brief loading period, blue (bus) and yellow (train) circular markers appear on the map.
    4.  Open the browser's Network tab in the developer tools.
    5.  **Confirm**: A request is made to `/api/transit` approximately every 20 seconds.
    6.  **Confirm**: The positions of the markers on the map change slightly after a few refresh intervals, indicating they are tracking live movement.

---

## Success Criteria

This milestone is complete when:
1.  Real-time bus and train locations are fetched from the backend API and displayed on the map.
2.  The vehicle positions update automatically on a regular interval.
3.  The implementation uses `swr` for efficient and resilient client-side data fetching.
4.  Buses and trains are visually distinguishable.
5.  All acceptance criteria are met and manual verification passes.

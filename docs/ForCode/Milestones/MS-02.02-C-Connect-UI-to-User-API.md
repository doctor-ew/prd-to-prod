# Milestone MS-02.02-C: Connect UI to User API

## Framework: M-A-P-S

### Motivation
Our application can now store user preferences, but the user has no way to express them. We need to connect our existing UI components (`LanguageSwitcher`, `VenueMarker`) to the `/api/user` backend so that user interactions are saved. We also need a way to generate and manage a stable ID for the user across sessions.

### Audience
This is for the end-user who wants a personalized experience. When they change the language, they expect it to be remembered. When they favorite a venue, they expect to see that choice reflected.

### Pain Points
-   Currently, language preference is lost on every page reload.
-   There is no way to "favorite" a venue.
-   The application treats every visitor as a new user on every visit.

### Solution
1.  **User ID Management**: Create a client-side hook (`useUserId`) that gets a unique user ID from `localStorage` or generates a new one if it doesn't exist. This provides a stable identity for anonymous users.
2.  **Language Persistence**: Modify the `LanguageSwitcher` to call our new `/api/user` endpoint whenever the language is changed.
3.  **Favorite Action**: Add a "favorite" button to the `VenueMarker`'s info window or popup. Clicking this button will call the `/api/user` endpoint to toggle the venue's favorite status.
4.  **Visual Feedback**: The UI should update immediately to reflect the new state (e.g., the favorite button changes color).

---

## Learning Outcomes

-   **Outcome 1**: Learn a common pattern for managing anonymous user identity on the client-side using `localStorage`.
-   **Outcome 2**: Understand how to make `POST` requests from a React client component to an API route to mutate server-side data.
-   **Outcome 3**: Gain experience with optimistic UI updates and data revalidation using `swr` to ensure the UI stays in sync with the backend state.

---

## Context from Source Docs

**Business Rationale (PRD)**: Fulfills the core "Personalized User Experience" feature by allowing users to save preferences and favorite venues.
**WBS Alignment**: Phase 3 development. This connects the frontend UI to the user feature backend.
**Dependencies**: MS-02.02-B (Create API Routes for User Actions).
**Files to Create/Modify**:
-   `src/hooks/useUserId.ts` (new file)
-   `src/components/LanguageSwitcher.tsx`
-   `src/components/VenueMarker.tsx`
-   `src/components/MapView.tsx`

**Acceptance Criteria**:
-   Changing the language saves the preference to the database and is remembered on page reload.
-   Clicking a "favorite" icon on a venue saves this preference to the database.
-   The favorite icon's state (e.g., filled or outlined) correctly reflects the saved user preference.
-   A stable user ID is generated and stored in `localStorage`.

---

## Guardrails

-   **Data Handling**: The client-side user ID is for personalization only and **must not** be considered a secure authentication token.
-   **UX**: All actions that mutate data (changing language, favoriting) **must** provide immediate visual feedback. Use `swr`'s `mutate` function for optimistic updates where appropriate.
-   **Code Quality**: The user ID logic **must** be encapsulated in a reusable `useUserId` hook.

---

## Implementation Checklist

-   [ ] **Task 1**: Create the `useUserId` hook.
    -   **Action**: Create a new file at `src/hooks/useUserId.ts`.
    ```ts
    'use client';
    import { useState, useEffect } from 'react';
    import { v4 as uuidv4 } from 'uuid';

    export function useUserId() {
      const [userId, setUserId] = useState<string | null>(null);

      useEffect(() => {
        let currentUserId = localStorage.getItem('userId');
        if (!currentUserId) {
          currentUserId = uuidv4();
          localStorage.setItem('userId', currentUserId);
        }
        setUserId(currentUserId);
      }, []);

      return userId;
    }
    ```
    -   **Action**: Install uuid: `pnpm add uuid && pnpm add -D @types/uuid`
    -   **Acceptance**: The hook is created and correctly uses `localStorage`.
-   [ ] **Task 2**: Update `LanguageSwitcher` to persist changes.
    -   **Action**: Modify `src/components/LanguageSwitcher.tsx` to use the `useUserId` hook and make a `POST` request on change.
    ```tsx
    // ... imports
    import { useUserId } from '@/hooks/useUserId';

    export default function LanguageSwitcher() {
      const userId = useUserId();
      // ... (existing code)

      const handleLanguageChange = async (locale: string) => {
        if (!userId) return;
        // This is an optimistic update, the UI changes immediately
        // The actual persistence happens in the background
        await fetch('/api/user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, language: locale }),
        });
      };

      return (
        <div className="...">
          {i18n.locales.map((locale) => (
            <Link
              key={locale}
              href={redirectedPathName(locale)}
              onClick={() => handleLanguageChange(locale)} // Call the API on click
              className="..."
            >
              {locale.toUpperCase()}
            </Link>
          ))}
        </div>
      );
    }
    ```
    -   **Acceptance**: The component now sends the language preference to the backend.
-   [ ] **Task 3**: Update `VenueMarker` to include a favorite button.
    -   **Action**: Modify `src/components/VenueMarker.tsx` to include a state for the info window and a favorite button.
    ```tsx
    'use client';
    import React, { useState } from 'react';
    import { AdvancedMarker, InfoWindow } from '@vis.gl/react-google-maps';

    type VenueMarkerProps = {
      // ... existing props
      isFavorite: boolean;
      onToggleFavorite: () => void;
    };

    const VenueMarker = ({ lat, lng, isFavorite, onToggleFavorite }: VenueMarkerProps) => {
      const [infoWindowShown, setInfoWindowShown] = useState(false);

      return (
        <>
          <AdvancedMarker position={{ lat, lng }} onClick={() => setInfoWindowShown(true)}>
            <img src={isFavorite ? "/assets/stadium-icon-fav.svg" : "/assets/stadium-icon.svg"} alt="Stadium" width="32" height="32" />
          </AdvancedMarker>
          {infoWindowShown && (
            <InfoWindow position={{ lat, lng }} onCloseClick={() => setInfoWindowShown(false)}>
              <div>
                <h3>Mercedes-Benz Stadium</h3>
                <button onClick={onToggleFavorite} className="text-blue-500">
                  {isFavorite ? '★ Unfavorite' : '☆ Favorite'}
                </button>
              </div>
            </InfoWindow>
          )}
        </>
      );
    };
    export default VenueMarker;
    ```
    -   **Action**: Create a favorited icon at `public/assets/stadium-icon-fav.svg` (e.g., a yellow star).
-   [ ] **Task 4**: Update `MapView` to manage and pass down favorite state.
    -   **Action**: Modify `src/components/MapView.tsx` to fetch user data, manage favorites, and pass props to the marker.
    ```tsx
    // ... imports
    import { useUserId } from '@/hooks/useUserId';

    const MapView = () => {
      const userId = useUserId();
      const { data: userData, mutate } = useSWR(userId ? `/api/user?userId=${userId}` : null, fetcher);
      // ... (existing state)

      const handleToggleFavorite = async (venueId: string) => {
        if (!userId) return;
        // Optimistic update
        mutate(
          (data: any) => {
            const isFavorite = data.favorites.some((fav: any) => fav.venueId === venueId);
            const newFavorites = isFavorite
              ? data.favorites.filter((fav: any) => fav.venueId !== venueId)
              : [...data.favorites, { venueId }];
            return { ...data, favorites: newFavorites };
          },
          false // do not revalidate yet
        );
        await fetch('/api/user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, venueId }),
        });
        mutate(); // Revalidate with server state
      };

      const isMbsFavorite = userData?.favorites.some((fav: any) => fav.venueId === 'ID_OF_MBS_STADIUM');

      return (
        <APIProvider ...>
          <div ...>
            <Map ...>
              <VenueMarker
                lat={stadiumPosition.lat}
                lng={stadiumPosition.lng}
                isFavorite={isMbsFavorite}
                onToggleFavorite={() => handleToggleFavorite('ID_OF_MBS_STADIUM')}
              />
              {/* ... other markers */}
            </Map>
            {/* ... controls */}
          </div>
        </APIProvider>
      );
    };
    ```
    -   **Note**: You will need to replace `'ID_OF_MBS_STADIUM'` with the actual ID from your seeded database.
    -   **Acceptance**: The map now fetches user data and controls the favorite state of the venue marker.

---

## Testing Requirements

-   [ ] **Manual Verification**:
    1.  Run `pnpm dev`.
    2.  Open the browser's developer tools, go to the "Application" tab, and check `localStorage`. **Confirm** a `userId` key has been created.
    3.  **Test Language**: Change the language to "ES". Reload the page. **Confirm** the language remains "ES".
    4.  **Test Favorite**: Click the stadium marker to open the info window. Click the "☆ Favorite" button.
    5.  **Confirm**: The button text changes to "★ Unfavorite" and the marker icon might change.
    6.  Reload the page. Click the marker again. **Confirm** it still shows "★ Unfavorite".
    7.  Click "★ Unfavorite". Reload the page. **Confirm** it has reverted to "☆ Favorite".

---

## Success Criteria

This milestone is complete when:
1.  User language and favorite preferences are successfully persisted on the backend.
2.  The UI correctly reflects the user's saved preferences, even after a page reload.
3.  A stable anonymous user ID is managed on the client.
4.  All acceptance criteria are met.

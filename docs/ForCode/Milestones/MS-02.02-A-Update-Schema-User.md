# Milestone MS-02.02-A: Update Schema for User Features

## Framework: S-P-A-R-K

### Situation
The application is currently anonymous. There is no way to store user-specific information, such as their preferred language or their favorite venues. To build personalization features, we first need to create the database tables to hold this data. We will re-introduce the `UserProfile` and `UserFavorite` models that were removed earlier.

### Purpose
The goal is to update the Prisma schema to include models for `UserProfile` and `UserFavorite`. This will create the necessary database structure to persist user preferences and selections across sessions.

### Audience
This prompt is for an AI coding assistant being guided by a non-technical user. The instructions must be followed exactly.

### Roadmap
1.  Open the `prisma/schema.prisma` file.
2.  Add the `UserProfile` and `UserFavorite` model definitions.
3.  Establish the relationships between users, venues, and their favorites.
4.  Run the Prisma migration command to apply the changes to the database.

### Knowledge
-   You will be adding two new models to the `prisma/schema.prisma` file.
-   A `UserProfile` can have many `UserFavorite`s (a one-to-many relationship).
-   A `Venue` can be favorited by many `UserProfile`s (also a one-to-many relationship).
-   The `UserFavorite` table acts as a join table to link users and venues.

---

## Learning Outcomes

-   **Outcome 1**: Learn how to model many-to-many relationships in Prisma using a join table.
-   **Outcome 2**: Understand how to add unique constraints to a table to prevent duplicate entries (e.g., a user favoriting the same venue twice).
-   **Outcome 3**: Reinforce the iterative database development workflow by running another migration to evolve the schema.

---

## Context from Source Docs

**Business Rationale (PRD)**: To "Enable users to favorite teams, venues, or event types" and "Deliver tailored notifications and suggested itineraries." Storing favorites is the first step.
**WBS Alignment**: Phase 3 development. This is the database foundation for user personalization features.
**Dependencies**: MS-01.04-A (Initial schema for events/venues).
**Files to Create/Modify**:
-   `prisma/schema.prisma`

**Acceptance Criteria**:
-   The `UserProfile` and `UserFavorite` models are correctly defined in `prisma/schema.prisma`.
-   Running `pnpm prisma migrate dev` completes successfully.
-   A new migration file is created in the `prisma/migrations` directory reflecting these changes.
-   The local `prisma/dev.db` file is updated to include the new `UserProfile` and `UserFavorite` tables.

---

## Guardrails

-   **Data & APIs**: The schema **must** match the definition provided in `docs/spec.md`. The `UserProfile` ID will correspond to a client-generated session or device ID for this MVP, not a full authentication system.
-   **Development Process**: All schema changes **must** be applied via a Prisma migration.

---

## Implementation Checklist

-   [ ] **Task 1**: Update the Prisma Schema.
    -   **Action**: Open `prisma/schema.prisma` and add the `UserProfile` and `UserFavorite` models. The final schema should look like this:
    ```prisma
    generator client {
      provider = "prisma-client-js"
    }

    datasource db {
      provider = "sqlite"
      url      = "file:./dev.db"
    }

    model Event {
      id          String   @id @default(cuid())
      fifaEventId String   @unique
      name        String
      description String
      startTime   DateTime
      venueId     String
      venue       Venue    @relation(fields: [venueId], references: [id])
    }

    model Venue {
      id        String         @id @default(cuid())
      name      String
      address   String
      latitude  Float
      longitude Float
      events    Event[]
      favorites UserFavorite[] // Add this relation
    }

    model UserProfile {
      id        String         @id @default(cuid())
      language  String         @default("en")
      favorites UserFavorite[]
      createdAt DateTime       @default(now())
    }

    model UserFavorite {
      id        String      @id @default(cuid())
      profileId String
      venueId   String
      profile   UserProfile @relation(fields: [profileId], references: [id])
      venue     Venue       @relation(fields: [venueId], references: [id])

      @@unique([profileId, venueId])
    }
    ```
    -   **Acceptance**: The `prisma/schema.prisma` file is updated to include the new models and the updated relation on `Venue`.
-   [ ] **Task 2**: Run the database migration.
    -   **Action**: Run this exact command in the terminal: `pnpm prisma migrate dev --name user-features-models`
    -   **Acceptance**: The command completes successfully, and a new migration is generated.

---

## Testing Requirements

-   [ ] **Manual Verification**:
    1.  After the migration command finishes, check the `prisma/migrations` directory.
    2.  **Confirm**: A new folder exists with a name that includes `user-features-models`.
    3.  **Confirm**: The `migration.sql` file inside contains `CREATE TABLE "UserProfile"` and `CREATE TABLE "UserFavorite"` statements.
    4.  Run `pnpm prisma studio`.
    5.  **Confirm**: The `UserProfile` and `UserFavorite` models are now visible in the Prisma Studio sidebar.

---

## Success Criteria

This milestone is complete when:
1.  The Prisma schema is updated to support user profiles and favorited venues.
2.  A successful database migration has been applied.
3.  The underlying SQLite database now contains the necessary tables for user personalization features.
4.  All acceptance criteria are met.
